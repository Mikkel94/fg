sudo: required

language: python
python:
  - 3.6

services:
  - docker

env:
  DOCKER_COMPOSE_VERSION: 1.13.0

before_install:
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-engine
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

install:
  - bash development.sh

addons:
  ssh_known_hosts: 146.185.181.250 # Our staging server is located here

jobs:
  include:
    - stage: test django
      script:
        - docker exec -it django python manage.py test
    - stage: test angular
      install:
        - npm -v
    - stage: deploy
      before_deploy:
        - openssl aes-256-cbc -K $encrypted_f56fe3551327_key -iv $encrypted_f56fe3551327_iv -in deploy_rsa.enc -out /tmp/deploy_rsa -d
        - eval "$(ssh-agent -s)"
        - chmod 600 /tmp/deploy_rsa
        - ssh-add /tmp/deploy_rsa
      deploy:
        provider: script
        skip_cleanup: true
        script: bash $TRAVIS_BUILD_DIR/deploy_staging.sh
        on:
          branch: development

# This sets up the ssh key for travis, the deploy_rsa.enc is encrypted and can safely be stored on the git repo
# before_deploy:
#   - openssl aes-256-cbc -K $encrypted_f56fe3551327_key -iv $encrypted_f56fe3551327_iv -in deploy_rsa.enc -out /tmp/deploy_rsa -d
#   - eval "$(ssh-agent -s)"
#   - chmod 600 /tmp/deploy_rsa
#   - ssh-add /tmp/deploy_rsa

# # This script is run by the travis CI machine given all previous steps are successful
# deploy:
#   provider: script
#   skip_cleanup: true
#   script: bash $TRAVIS_BUILD_DIR/deploy_staging.sh
#   on:
#     branch: development