sudo: required
language: node_js
node_js:
  - 8
services:
  - docker

addons:
  ssh_known_hosts: 146.185.181.250 # Our staging server is located here

jobs:
  include:
    - stage: test django
      env:
        - DOCKER_COMPOSE_VERSION=1.14.0
      install:
        - docker -v
        - sudo rm /usr/local/bin/docker-compose
        - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
        - chmod +x docker-compose
        - sudo mv docker-compose /usr/local/bin
        - bash travis.sh
      script:
        - docker exec -i django python manage.py makemigrations
        - docker exec -i django python manage.py test fg.api fg.fg_auth

    - stage: test angular
      install:
        - npm install -g @angular/cli@1.2.0
        - cd src/angular_frontend && npm install
      script:
        - ng build
        - ng test --watch=false
        
    - stage: deploy
      script: echo "Deploying to staging..."
      before_deploy:
        - openssl aes-256-cbc -K $encrypted_f56fe3551327_key -iv $encrypted_f56fe3551327_iv -in deploy_rsa.enc -out /tmp/deploy_rsa -d
        - eval "$(ssh-agent -s)"
        - chmod 600 /tmp/deploy_rsa
        - ssh-add /tmp/deploy_rsa
      deploy:
        provider: script
        skip_cleanup: true
        script: bash $TRAVIS_BUILD_DIR/deploy_staging.sh
        on:
          branch: development
